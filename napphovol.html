<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>GoTo Phone Number Report</title>
  <style>
    body { font-family: 'Segoe UI', Arial, sans-serif; background: #f8f9fa; margin: 0; padding: 0; }
    .container { max-width: 900px; margin: 40px auto; background: #fff; border-radius: 8px; box-shadow: 0 4px 24px rgba(0,0,0,0.08); padding: 32px; }
    h1 { color: #007bff; margin-bottom: 24px; }
    label { font-weight: 500; margin-top: 16px; display: block; }
    input, select { padding: 8px; margin-top: 4px; width: 100%; border-radius: 4px; border: 1px solid #ccc; }
    button { background: #007bff; color: #fff; border: none; border-radius: 4px; padding: 10px 24px; font-size: 16px; cursor: pointer; margin-top: 24px; }
    button:disabled { background: #aaa; }
    .debug { background: #e9ecef; padding: 12px; border-radius: 4px; margin-top: 18px; font-size: 14px; color: #333; }
    table { width: 100%; border-collapse: collapse; margin-top: 24px; }
    th, td { padding: 10px; border-bottom: 1px solid #eee; text-align: left; }
    th { background: #f1f3f6; }
    .alert { background: #ffe5e5; color: #b30000; padding: 12px; border-radius: 4px; margin-top: 18px; }
  </style>
</head>
<body>
  <div class="container">
    <h1>GoTo Phone Number Report</h1>
    <label for="accessToken">Access Token</label>
    <input type="password" id="accessToken" placeholder="Paste your OAuth access token here">
    <label for="organizationId">Organization ID</label>
    <input type="text" id="organizationId" placeholder="Organization ID">
    <label for="accountKey">Account Key (optional)</label>
    <input type="text" id="accountKey" placeholder="Account Key">
    <!-- new: start/end date inputs -->
    <label for="startDate">Start Date</label>
    <input type="date" id="startDate" value="">
    <label for="endDate">End Date</label>
    <input type="date" id="endDate" value="">
    <label for="phoneNumber">Phone Number</label>
    <select id="phoneNumber"></select>
    <label for="nameFilter">Filter by Name</label>
    <input type="text" id="nameFilter" placeholder="Type part of a name to filter activity and numbers">
    <div style="display:flex;gap:8px;">
      <button id="fetchBtn">Fetch Phone Number</button>
      <button id="exportBtn">Export CSV</button>
      <button id="loadActivityBtn">Load Phone Activity</button>
    </div>
    <div style="margin-top:8px; display:flex;gap:8px; align-items:center;">
      <label style="margin:0;">Page:</label>
      <button id="pagePrev">Prev</button>
      <span id="pageDisplay">1</span>
      <button id="pageNext">Next</button>
      <label style="margin-left:12px;">Page Size:</label>
      <select id="pageSizeSelect"><option>10</option><option selected>50</option><option>100</option><option>500</option></select>
    </div>
    <div class="debug" id="debugWindow"></div>
    <div id="results"></div>
    <div id="activityResults" style="margin-top:18px"></div>
  </div>
  <script>
    async function fetchScimAccounts(){
      try {
        const resp = await fetch('/list-scim-accounts');
        if (!resp.ok) return [];
        const j = await resp.json();
        return j.accounts || [];
      } catch (e) { return []; }
    }

    async function populateAccountsSelector(){
      const accounts = await fetchScimAccounts();
      // Try to find existing input or select element for accountKey
      let existing = document.getElementById('accountKey') || document.getElementById('accountKeySelect');
      const container = document.querySelector('.container') || document.body;
      // Helper to create and populate a select element
      function makeSelect(){
        const newSel = document.createElement('select');
        newSel.id = 'accountKeySelect';
        newSel.style.width = '100%';
        newSel.style.marginTop = '4px';
        accounts.forEach(a => {
          const opt = document.createElement('option');
          opt.value = a.value;
          opt.textContent = (a.display || a.value) + (a.entitlements && a.entitlements.length ? ' [' + a.entitlements.join(',') + ']' : '');
          newSel.appendChild(opt);
        });
        return newSel;
      }

      if (!existing) {
        // No existing field found — insert new select after the accountKey label if possible
        const label = document.querySelector('label[for="accountKey"]');
        const parent = label ? label.parentElement : container;
        const sel = makeSelect();
        if (label && label.nextSibling) parent.insertBefore(sel, label.nextSibling);
        else parent.appendChild(sel);
        return;
      }

      // If existing is an input, replace it with a select
      if (existing.tagName === 'INPUT') {
        const parent = existing.parentElement || container;
        const sel = makeSelect();
        parent.replaceChild(sel, existing);
        return;
      }

      // If existing is a select, just repopulate it
      if (existing.tagName === 'SELECT') {
        existing.innerHTML = '';
        accounts.forEach(a => {
          const opt = document.createElement('option');
          opt.value = a.value;
          opt.textContent = (a.display || a.value) + (a.entitlements && a.entitlements.length ? ' [' + a.entitlements.join(',') + ']' : '');
          existing.appendChild(opt);
        });
        return;
      }
    }

    async function prepopulate(){
      try {
        // token + org
        const [tokenResp, envResp] = await Promise.all([fetch('/api/latest-access-token'), fetch('/api/env-vars')]);
        const tokenData = await tokenResp.json();
        const envData = await envResp.json();
        if (tokenData.accessToken) document.getElementById('accessToken').value = tokenData.accessToken;
        if (envData.organizationId) document.getElementById('organizationId').value = envData.organizationId;
        // DO NOT repopulate accounts here (avoids resetting user's selection)

        // determine account key to use (if selector exists use its current value)
        const accountSel = document.getElementById('accountKeySelect');
        const accountKeyToUse = accountSel ? accountSel.value : (document.getElementById('accountKey') ? document.getElementById('accountKey').value : '');
        await fetchAndFillNumbers(accountKeyToUse);
      } catch (err) {
        document.getElementById('debugWindow').textContent = 'Error prepopulating: ' + err.message;
      }
    }

    // New helper: escape HTML for safe pre text rendering
    function escapeHtml(str) {
      if (!str) return '';
      return str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
    }

    // State: last fetched items for client-side filtering
    let lastActivityItems = [];
    let lastNumbers = [];

    // Apply name filter to both activity table and phone number select
    function applyNameFilter() {
      const nfEl = document.getElementById('nameFilter');
      const q = (nfEl && nfEl.value) ? nfEl.value : '';
      const ql = q.trim().toLowerCase();
      // Filter phone number options
      const phoneSelect = document.getElementById('phoneNumber');
      if (phoneSelect && Array.isArray(lastNumbers)) {
        phoneSelect.innerHTML = '';
        const filtered = lastNumbers.filter(n => {
          const name = (n.callerId || n.callerIdName || n.name || '').toString().toLowerCase();
          const num = (n.phoneNumber || n.number || '').toString().toLowerCase();
          return ql === '' || name.includes(ql) || num.includes(ql);
        });
        filtered.forEach(n => {
          const option = document.createElement('option');
          const numVal = n.phoneNumber || n.number || '';
          option.value = numVal;
          option.textContent = numVal + (n.callerId ? ' (' + n.callerId + ')' : (n.callerIdName ? ' (' + n.callerIdName + ')' : ''));
          phoneSelect.appendChild(option);
        });
      }

      // Filter activity table if we have loaded items
      if (Array.isArray(lastActivityItems) && lastActivityItems.length > 0) {
        const filteredAct = lastActivityItems.filter(it => {
          // Candidate fields to match: phoneNumberName, callerIdName, callerId, phoneNumber
          const nameFields = [it.phoneNumberName, it.phoneNumberId, it.callerIdName, it.callerId, it.phoneNumber];
          for (const f of nameFields) {
            if (!f) continue;
            if (f.toString().toLowerCase().includes(ql)) return true;
          }
          // also check nested caller/callee names
          if (it.calleeId && it.calleeId.name && it.calleeId.name.toString().toLowerCase().includes(ql)) return true;
          if (it.callerId && it.callerId.name && it.callerId.name.toString().toLowerCase().includes(ql)) return true;
          return ql === '';
        });
        renderActivityTotals(filteredAct);
        renderActivityTable(filteredAct);
      }
    }

    // New helper: fetch numbers and fill dropdown — does not touch accounts selector
    async function fetchAndFillNumbers(accountKeyToUse){
      try {
        const url = accountKeyToUse ? `/phone-numbers-summary?accountKey=${encodeURIComponent(accountKeyToUse)}` : '/phone-numbers-summary';
        const phoneResp = await fetch(url);
        const phoneSelect = document.getElementById('phoneNumber');
        phoneSelect.innerHTML = '';

        if (!phoneResp.ok) {
          // Try to parse JSON response body for details, fall back to text
          let detailsText = '';
          try { const j = await phoneResp.json(); detailsText = JSON.stringify(j, null, 2); } catch (e) { detailsText = await phoneResp.text(); }
          const msg = `Failed to load phone numbers: HTTP ${phoneResp.status}`;
          document.getElementById('debugWindow').textContent = msg + '\n' + detailsText;
          document.getElementById('results').innerHTML = `<div class="alert">${escapeHtml(msg)}<pre>${escapeHtml(detailsText)}</pre></div>`;
          return;
        }

        const payload = await phoneResp.json();
        const numbers = payload.phoneNumbers || payload || [];
        // persist for client-side filtering
        lastNumbers = numbers;
        const phoneSelect2 = document.getElementById('phoneNumber');
        phoneSelect2.innerHTML = '';
        numbers.forEach(n => {
          const option = document.createElement('option');
          const numVal = n.phoneNumber || n.number || '';
          option.value = numVal;
          option.textContent = numVal + (n.callerId ? ' (' + n.callerId + ')' : '');
          phoneSelect2.appendChild(option);
        });
        // apply any active name filter to reduce options immediately
        applyNameFilter();
        const acctInfo = payload.accountDisplay || payload.accountKey || (accountKeyToUse || '');
        document.getElementById('debugWindow').textContent = `Loaded ${numbers.length} numbers for account: ${acctInfo} (source: ${payload.source || 'unknown'})`;
        document.getElementById('results').innerHTML = '';
        return payload;
      } catch (err) {
        // err may be a network/fetch error or thrown object; try to present useful info
        let details = err && err.message ? err.message : String(err);
        if (err && err.details) {
          try { details += '\n' + JSON.stringify(err.details, null, 2); } catch (e) { details += '\n' + String(err.details); }
        }
        document.getElementById('debugWindow').textContent = 'Error loading numbers: ' + details;
        document.getElementById('results').innerHTML = `<div class="alert">Error loading numbers: <pre>${escapeHtml(details)}</pre></div>`;
        return null;
      }
    }

    // Export current numbers to CSV and display as table
    function buildCsvFromNumbers(numbers) {
      const rows = [['phoneNumber','callerId']];
      numbers.forEach(n => {
        rows.push([n.phoneNumber || n.number || '', n.callerId || '']);
      });
      return rows.map(r => r.map(c => '"' + String(c).replace(/"/g,'""') + '"').join(',')).join('\n');
    }

    function renderNumbersTable(numbers) {
      if (!numbers || numbers.length === 0) return '<div class="empty">No numbers to display</div>';
      let html = '<table><thead><tr><th>Phone Number</th><th>Caller ID</th></tr></thead><tbody>';
      numbers.forEach(n => { html += `<tr><td>${escapeHtml(n.phoneNumber || n.number || '')}</td><td>${escapeHtml(n.callerId || '')}</td></tr>`; });
      html += '</tbody></table>';
      return html;
    }

    window.addEventListener('DOMContentLoaded', async ()=>{
      // populate accounts once, then prepopulate numbers
      await populateAccountsSelector();
      await prepopulate();
    });

    document.getElementById('fetchBtn').addEventListener('click', async ()=>{
      // read current selection and fetch numbers only (do not repopulate accounts)
      const accountSel = document.getElementById('accountKeySelect');
      const accountKeyToUse = accountSel ? accountSel.value : (document.getElementById('accountKey') ? document.getElementById('accountKey').value : '');
      document.getElementById('fetchBtn').disabled = true;
      document.getElementById('fetchBtn').textContent = 'Loading...';
      await fetchAndFillNumbers(accountKeyToUse);
      document.getElementById('fetchBtn').disabled = false;
      document.getElementById('fetchBtn').textContent = 'Fetch Phone Number';
    });

    // Fetch page of persisted DB rows
    async function fetchDbPage(accountKey, page, pageSize) {
      const params = new URLSearchParams();
      if (accountKey) params.append('accountKey', accountKey);
      params.append('page', page);
      params.append('pageSize', pageSize);
      const resp = await fetch('/db/phone-numbers?' + params.toString());
      if (!resp.ok) throw new Error('DB request failed: ' + resp.status);
      return resp.json();
    }

    async function loadPageToUi(page) {
      const accountSel = document.getElementById('accountKeySelect');
      const accountKeyToUse = accountSel ? accountSel.value : (document.getElementById('accountKey') ? document.getElementById('accountKey').value : '');
      const pageSize = parseInt(document.getElementById('pageSizeSelect').value, 10) || 50;
      try {
        const data = await fetchDbPage(accountKeyToUse, page, pageSize);
        document.getElementById('pageDisplay').textContent = data.page;
        const rows = data.rows || [];
        document.getElementById('results').innerHTML = renderNumbersTable(rows.map(r=>({ phoneNumber: r.number, callerId: r.callerIdName || r.callerId || '' })));
        // store last loaded page in a data attribute for export convenience
        document.getElementById('results').dataset.lastAccount = accountKeyToUse || '';
        document.getElementById('results').dataset.lastPage = data.page;
        document.getElementById('results').dataset.lastPageSize = data.pageSize;
      } catch (e) {
        document.getElementById('results').innerHTML = `<div class="alert">Error loading page: ${escapeHtml(e.message)}</div>`;
      }
    }

    document.getElementById('pagePrev').addEventListener('click', async ()=>{
      const cur = parseInt(document.getElementById('pageDisplay').textContent || '1', 10) || 1;
      if (cur <= 1) return;
      await loadPageToUi(cur - 1);
    });
    document.getElementById('pageNext').addEventListener('click', async ()=>{
      const cur = parseInt(document.getElementById('pageDisplay').textContent || '1', 10) || 1;
      await loadPageToUi(cur + 1);
    });
    document.getElementById('pageSizeSelect').addEventListener('change', async ()=>{
      await loadPageToUi(1);
    });

    // Export all pages from DB by iterating server-side pages
    document.getElementById('exportBtn').addEventListener('click', async () => {
      const accountKeyToUse = document.getElementById('results').dataset.lastAccount || '';
      const pageSize = parseInt(document.getElementById('pageSizeSelect').value, 10) || 50;
      document.getElementById('exportBtn').disabled = true; document.getElementById('exportBtn').textContent = 'Exporting...';
      try {
        // First fetch first page to get total
        const first = await fetchDbPage(accountKeyToUse, 1, pageSize);
        const total = first.total || 0;
        const pages = Math.max(1, Math.ceil(total / pageSize));
        let allRows = first.rows || [];
        for (let p = 2; p <= pages; p++) {
          const pg = await fetchDbPage(accountKeyToUse, p, pageSize);
          allRows = allRows.concat(pg.rows || []);
        }
        const numbers = allRows.map(r => ({ phoneNumber: r.number, callerId: r.callerIdName || r.callerId || '' }));
        document.getElementById('results').innerHTML = renderNumbersTable(numbers);
        const csv = buildCsvFromNumbers(numbers);
        const blob = new Blob([csv], { type: 'text/csv' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        const fname = `phone-numbers-${accountKeyToUse || 'all'}.csv`;
        a.href = url; a.download = fname; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
      } catch (e) {
        document.getElementById('results').innerHTML = `<div class="alert">Export failed: ${escapeHtml(e.message)}</div>`;
      } finally {
        document.getElementById('exportBtn').disabled = false; document.getElementById('exportBtn').textContent = 'Export CSV';
      }
    });

    // Initialize page state
    document.addEventListener('DOMContentLoaded', ()=>{ document.getElementById('pageDisplay').textContent = '1'; });

    // Quick client integration: load saved phone number activity JSON and render table/totals
    const MAX_DAYS = parseInt((window.MAX_ACTIVITY_DAYS_OVERRIDE || '90'), 10) || 90; // client-side guard

    function safeReadBody(resp) {
      return resp.text().then(t => {
        try { return JSON.stringify(JSON.parse(t), null, 2); } catch(e) { return t; }
      });
    }

    function setLoading(isLoading) {
      const btn = document.getElementById('loadActivityBtn');
      if (btn) { btn.disabled = isLoading; btn.textContent = isLoading ? 'Loading...' : 'Load Phone Activity'; }
      const dbg = document.getElementById('debugWindow');
      if (dbg) dbg.textContent = isLoading ? 'Loading phone activity from server...' : '';
    }

    function showError(message) {
      const target = document.getElementById('activityResults');
      target.innerHTML = `<div class="alert">${escapeHtml(message)}</div>`;
    }

    async function loadPhoneActivity() {
      const target = document.getElementById('activityResults');
      target.innerHTML = '';
      const accountSel = document.getElementById('accountKeySelect');
      const accountKeyToUse = accountSel ? accountSel.value : (document.getElementById('accountKey') ? document.getElementById('accountKey').value : '');
      const organizationId = (document.getElementById('organizationId') || {}).value || '';
      const start = (document.getElementById('startDate') || {}).value;
      const end = (document.getElementById('endDate') || {}).value;

      if (!accountKeyToUse) { showError('Missing accountKey. Select or enter an accountKey.'); return; }
      if (!organizationId) { showError('Missing organizationId. Set organization ID in the input or select an account with org metadata.'); return; }
      if (!start || !end) { showError('Please provide both start and end dates.'); return; }

      const startDate = new Date(start + 'T00:00:00Z');
      const endDate = new Date(end + 'T23:59:59Z');
      if (Number.isNaN(startDate.getTime()) || Number.isNaN(endDate.getTime()) || startDate > endDate) {
        showError('Invalid start or end date');
        return;
      }
      const msPerDay = 24 * 60 * 60 * 1000;
      const days = Math.round((endDate - startDate) / msPerDay) + 1;
      if (days > MAX_DAYS) { showError(`Date range too large: max ${MAX_DAYS} days`); return; }

      setLoading(true);
      try {
        const params = new URLSearchParams({ accountKey: accountKeyToUse, organizationId, start, end });
        const resp = await fetch('/phone-number-activity?' + params.toString());
        if (!resp.ok) {
          const body = await safeReadBody(resp);
          showError(`Server error ${resp.status}: ${body}`);
          return;
        }
        const payload = await resp.json();
        const items = payload.items || [];
        // store for filtering
        lastActivityItems = items;
        if (!Array.isArray(items) || items.length === 0) {
          target.innerHTML = `<div class="debug">No activity found for account ${escapeHtml(accountKeyToUse)} in the selected date range.</div>`;
          return;
        }
        renderActivityTotals(items);
        renderActivityTable(items);
        target.scrollIntoView({ behavior: 'smooth' });
      } catch (err) {
        const msg = err && err.message ? err.message : String(err);
        showError('Error loading activity: ' + msg);
      } finally {
        setLoading(false);
      }
    }

    function renderActivityTotals(items) {
      let inSum = 0, outSum = 0, totalDuration = 0;
      for (const it of items) {
        inSum += (it.dataValues?.inboundVolume || 0);
        outSum += (it.dataValues?.outboundVolume || 0);
        totalDuration += (it.dataValues?.totalDuration || 0);
      }
      const target = document.getElementById('activityResults');
      const html = `<div id="activityTotals" style="font-weight:600;margin-top:8px">Totals — Inbound: ${inSum}  Outbound: ${outSum}  TotalDuration(ms): ${totalDuration}</div>`;
      target.innerHTML = html;
      return { inSum, outSum, totalDuration };
    }

    function renderActivityTable(items) {
      const target = document.getElementById('activityResults');
      let html = target.innerHTML || '';
      html += '<table id="activityTable"><thead><tr><th>Phone</th><th>Name</th><th>Inbound</th><th>Outbound</th><th>TotalDuration(ms)</th></tr></thead><tbody>';
      for (const it of items) {
        const phone = escapeHtml(it.phoneNumber || '');
        const name = escapeHtml(it.phoneNumberName || it.phoneNumberId || '');
        const inV = it.dataValues?.inboundVolume || 0;
        const outV = it.dataValues?.outboundVolume || 0;
        const dur = it.dataValues?.totalDuration || 0;
        html += `<tr><td>${phone}</td><td>${name}</td><td>${inV}</td><td>${outV}</td><td>${dur}</td></tr>`;
      }
      html += '</tbody></table>';
      // attach export button for this activity view
      html += '<div style="margin-top:8px"><button id="exportActivityBtn">Export Activity CSV</button></div>';
      target.innerHTML = html;
      const btn = document.getElementById('exportActivityBtn');
      if (btn) btn.addEventListener('click', ()=> exportActivityCsv(items));
    }

    function exportActivityCsv(items) {
      const rows = [['phoneNumber','phoneNumberName','inbound','outbound','totalDuration']];
      items.forEach(it => rows.push([
        it.phoneNumber || '',
        it.phoneNumberName || it.phoneNumberId || '',
        it.dataValues?.inboundVolume || 0,
        it.dataValues?.outboundVolume || 0,
        it.dataValues?.totalDuration || 0
      ]));
      const csv = rows.map(r => r.map(c => '"' + String(c).replace(/"/g,'""') + '"').join(',')).join('\n');
      const blob = new Blob([csv], { type: 'text/csv' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = 'phone_activity_2025-10-30.csv'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
    }

    // wire the new button
    document.addEventListener('DOMContentLoaded', ()=>{
      const btn = document.getElementById('loadActivityBtn');
      if (btn) btn.addEventListener('click', loadPhoneActivity);
    });

    // Hook up the name filter input to live filter
    document.addEventListener('DOMContentLoaded', ()=>{
      const nf = document.getElementById('nameFilter');
      if (nf) {
        nf.addEventListener('input', ()=> applyNameFilter());
      }
    });
  </script>
</body>
</html>
